<div [formGroup]="jobCardForm">

  <!-- MAIN TITLE -->
  <div class="card mb-2">
    <div class="card-header bg-light d-flex justify-content-center align-items-center border-0"
         style="padding: 16px; font-size: 18px; font-weight: 600;">
      üìù New Job Card
    </div>
  </div>

  <mat-accordion multi>

    <!-- SECTION 1: Search Options & Vehicle Info -->
    <mat-expansion-panel [expanded]="expandAll">
      <mat-expansion-panel-header style="background-color: #3f51b5; color: white;" class="mt-4">
        <mat-panel-title style="color: white;">Search Options & Vehicle Info</mat-panel-title>
      </mat-expansion-panel-header>

      <br />
      <div class="mt-2">

        <app-autocomplete placeholder="Search by Reg No / Customer No / Mobile"
                          [searchFn]="jobcardService.searchRegistration.bind(jobcardService)"
                          (selected)="onSelectedRegistration($event)">
        </app-autocomplete>
        <input type="hidden" formControlName="id" />
        <br />
        <br />
        <div style="display: flex; gap: 10px; overflow-x: auto; padding: 5px;">
          <div class="simple-icon-box" (click)="openPopup('Service Package')">Service Package</div>
          <div class="simple-icon-box" (click)="openPopup('Service History')">Service History</div>
          <div class="simple-icon-box" (click)="openPopup('Feedback')">Feedback</div>
          <div class="simple-icon-box" (click)="openPopup('Due Amount')">Due Amount</div>
          <div class="simple-icon-box" (click)="openPopup('Reminders')">Reminders</div>
          <div class="simple-icon-box" (click)="openPopup('Battery/Tyre')">Battery/Tyre</div>
        </div>
      </div>
      
      <br />
      <br />
    </mat-expansion-panel>

    <!-- SECTION 2: Vehicle Data -->
    <mat-expansion-panel formGroupName="vehicleData" [expanded]="expandAll">
      <mat-expansion-panel-header style="background-color: #00bcd4; color: white;" class="mt-4">
        <mat-panel-title style="color: white;">Vehicle Data</mat-panel-title>
      </mat-expansion-panel-header>

      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <label>Registration No</label>
          <input class="form-control"
                 formControlName="registrationNo"
                 placeholder="Enter Registration Number">
          <div *ngIf="vehicleData.get('registrationNo')?.touched && vehicleData.get('registrationNo')?.invalid"
               class="text-danger small">
            Registration No is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Odometer In</label>
          <input appNumbersOnly class="form-control"
                 formControlName="odometerIn"
                 placeholder="Enter Odometer Reading">
          <div *ngIf="vehicleData.get('odometerIn')?.touched && vehicleData.get('odometerIn')?.invalid"
               class="text-danger small">
            Enter valid Odometer (positive number).
          </div>
        </div>

        <div class="col-md-4">
          <label>Avg KMS/Day</label>
          <input appNumbersOnly class="form-control"
                 formControlName="avgKmsPerDay"
                 placeholder="Enter Avg KMS/Day">
          <div *ngIf="vehicleData.get('avgKmsPerDay')?.touched && vehicleData.get('avgKmsPerDay')?.invalid"
               class="text-danger small">
            Average KMS/Day is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>VIN</label>
          <input class="form-control"
                 formControlName="vin"
                 placeholder="Enter VIN">
          <div *ngIf="vehicleData.get('vin')?.touched && vehicleData.get('vin')?.invalid"
               class="text-danger small">
            VIN is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Engine No</label>
          <input class="form-control"
                 formControlName="engineNo"
                 placeholder="Enter Engine Number">
          <div *ngIf="vehicleData.get('engineNo')?.touched && vehicleData.get('engineNo')?.invalid"
               class="text-danger small">
            Engine No is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Vehicle Colour</label>
          <select class="form-select" formControlName="vehicleColor">
            <option value="" disabled selected>Select Colour</option>
            <option>White</option>
            <option>Black</option>
            <option>Silver</option>
            <option>Red</option>
            <option>Blue</option>
            <option>Grey</option>
          </select>
          <div *ngIf="vehicleData.get('vehicleColor')?.touched && vehicleData.get('vehicleColor')?.invalid"
               class="text-danger small">
            Vehicle colour is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Fuel Type</label>
          <select class="form-select" formControlName="fuelType">
            <option value="" disabled selected>Select Fuel</option>
            <option>Petrol</option>
            <option>Diesel</option>
            <option>CNG</option>
            <option>Electric</option>
            <option>Hybrid</option>
          </select>
          <div *ngIf="vehicleData.get('fuelType')?.touched && vehicleData.get('fuelType')?.invalid"
               class="text-danger small">
            Fuel type is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Service Type</label>
          <select class="form-select" formControlName="serviceType">
            <option value="" disabled selected>Select Service</option>
            <option>Periodic Service</option>
            <option>Running Repairs</option>
            <option>Accidental Repair</option>
            <option>Major Service</option>
            <option>Inspection</option>
          </select>
          <div *ngIf="vehicleData.get('serviceType')?.touched && vehicleData.get('serviceType')?.invalid"
               class="text-danger small">
            Service type is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Service Advisor</label>
          <select class="form-select" formControlName="serviceAdvisor">
            <option value="" disabled selected>Select Advisor</option>
            <option>John</option>
            <option>Jane</option>
            <option>Robert</option>
          </select>
          <div *ngIf="vehicleData.get('serviceAdvisor')?.touched && vehicleData.get('serviceAdvisor')?.invalid"
               class="text-danger small">
            Service advisor is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Technician</label>
          <select class="form-select" formControlName="technician">
            <option value="" disabled selected>Select Technician</option>
            <option>Mike</option>
            <option>Sarah</option>
            <option>David</option>
          </select>
          <div *ngIf="vehicleData.get('technician')?.touched && vehicleData.get('technician')?.invalid"
               class="text-danger small">
            Technician is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Vendors</label>
          <select class="form-select" formControlName="vendor">
            <option value="" disabled selected>Select Vendor</option>
            <option>Vendor A</option>
            <option>Vendor B</option>
            <option>Vendor C</option>
          </select>
          <div *ngIf="vehicleData.get('vendor')?.touched && vehicleData.get('vendor')?.invalid"
               class="text-danger small">
            Vendor is required.
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- SECTION 3: Customer Concerns -->
    <mat-expansion-panel [expanded]="expandAll">
      <mat-expansion-panel-header style="background-color: #ff69b4; color: white;" class="mt-4">
        <mat-panel-title style="color: white;">Customer Concerns</mat-panel-title>
      </mat-expansion-panel-header>

      <div class="mt-2">
        <textarea class="form-control" [formControl]="newConcern" placeholder="Enter customer concerns"></textarea>
        <div *ngIf="newConcern.touched && newConcern.invalid" class="text-danger small">
          Enter a concern before adding.
        </div>

        <button class="btn btn-primary mt-2" (click)="addConcern()">Add Service</button>

        <div *ngIf="(concernsArray.invalid || concernsArray.length === 0) && (jobCardForm.touched)" class="text-danger small mt-2">
          Add at least one concern.
        </div>
        <div class="d-flex flex-wrap m-2">
          <div *ngFor="let c of concernsArray.controls; let i = index"
               class="d-flex align-items-center me-2 mb-2">

            <!-- Concern text -->
      
            <span (click)="toggleConcern(i)" class="me-2 px-3 py-2 rounded-pill border text-white"  style="cursor: pointer;  width: 200px; white-space: normal; word-break: break-word;text-align: left;" [ngClass]="{  'bg-success': c.value.active,'bg-secondary': !c.value.active }">                                      
              {{ c.value.text }}
            </span>

            <!-- Remove button -->
            <button type="button"
                    class="btn btn-sm btn-outline-danger align-self-center"
                    (click)="removeConcern(i)">
              Remove
            </button>
          </div>
        </div>

      </div>
    </mat-expansion-panel>

    <!-- SECTION 4: Customer & Corporate Info -->
    <mat-expansion-panel formGroupName="customerInfo" [expanded]="expandAll">
      <mat-expansion-panel-header style="background-color: #ffc107; color: white;" class="mt-4">
        <mat-panel-title style="color: white;">Customer & Corporate Info</mat-panel-title>
      </mat-expansion-panel-header>

      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <label>Corporate/Float</label>
          <select class="form-select" formControlName="corporate">
            <option value="" disabled selected>Select</option>
            <option value="Corporate">Corporate</option>
            <option value="Float">Float</option>
          </select>
          <div *ngIf="customerInfo.get('corporate')?.touched && customerInfo.get('corporate')?.invalid" class="text-danger small">
            Corporate/Float is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Customer Name</label>
          <input class="form-control" formControlName="customerName" placeholder="Enter Customer Name">
          <div *ngIf="customerInfo.get('customerName')?.touched && customerInfo.get('customerName')?.invalid" class="text-danger small">
            Customer name is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Mobile Number</label>
          <input appNumbersOnly class="form-control" formControlName="mobile" placeholder="Enter Mobile Number">
          <div *ngIf="customerInfo.get('mobile')?.touched && customerInfo.get('mobile')?.invalid" class="text-danger small">
            Enter valid 10-digit Indian mobile number.
          </div>
        </div>

        <div class="col-md-4">
          <label>Alternate Number</label>
          <input appNumbersOnly class="form-control" formControlName="alternateMobile" placeholder="Enter Alternate Mobile">
          <div *ngIf="customerInfo.get('alternateMobile')?.touched && customerInfo.get('alternateMobile')?.invalid" class="text-danger small">
            Enter valid alternate mobile (10 digits) or leave empty.
          </div>
        </div>

        <div class="col-md-4">
          <label>Email</label>
          <input class="form-control" formControlName="email" placeholder="Enter Email">
          <div *ngIf="customerInfo.get('email')?.touched && customerInfo.get('email')?.invalid" class="text-danger small">
            Enter valid email.
          </div>
        </div>

        <div class="col-md-4">
          <label>Est. Delivery Date</label>
          <input type="date" class="form-control" formControlName="deliveryDate" [min]="today">
          <div *ngIf="customerInfo.get('deliveryDate')?.touched && customerInfo.get('deliveryDate')?.invalid" class="text-danger small">
            Delivery date is required.
          </div>
        </div>

        <div class="col-md-4">
          <label>Insurance Company</label>
          <select class="form-select" formControlName="insuranceCompany">
            <option value="" disabled selected>Select Insurance</option>
            <option>LIC</option>
            <option>HDFC Ergo</option>
            <option>ICICI Lombard</option>
            <option>Bajaj Allianz</option>
            <option>Tata AIG</option>
            <option>SBI General</option>
          </select>
          <div *ngIf="customerInfo.get('insuranceCompany')?.touched && customerInfo.get('insuranceCompany')?.invalid" class="text-danger small">
            Insurance company is required.
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- SECTION 5: Advance Payment -->
    <mat-expansion-panel formGroupName="advancePayment" [expanded]="expandAll">
      <mat-expansion-panel-header style="background-color: #4caf50; color: white;" class="mt-4">
        <mat-panel-title style="color: white;">Advance Payment</mat-panel-title>
      </mat-expansion-panel-header>

      <div class="row g-2 mt-2">
        <div class="col-md-3">
          <label>Cash</label>
          <input appTwoDecimalNumbers class="form-control" formControlName="cash" placeholder="Enter Cash">
          <div *ngIf="advancePayment.get('cash')?.touched && advancePayment.get('cash')?.invalid" class="text-danger small">
            Cash is required.
          </div>
        </div>

        <div class="col-md-3">
          <label>Bank Name</label>
          <select class="form-select" formControlName="bankName">
            <option value="" disabled selected>Select Bank</option>
            <option>State Bank of India</option>
            <option>HDFC</option>
            <option>ICICI</option>
            <option>Axis Bank</option>
            <option>PNB</option>
          </select>
          <div *ngIf="advancePayment.get('bankName')?.touched && advancePayment.get('bankName')?.invalid" class="text-danger small">
            Bank name is required.
          </div>
        </div>

        <div class="col-md-3">
          <label>Cheque No</label>
          <input class="form-control" formControlName="chequeNo" placeholder="Enter Cheque Number">
          <div *ngIf="advancePayment.get('chequeNo')?.touched && advancePayment.get('chequeNo')?.invalid" class="text-danger small">
            Cheque number is required.
          </div>
        </div>

        <div class="col-md-3">
          <label>Amount</label>
          <input appTwoDecimalNumbers class="form-control" formControlName="amount" placeholder="Enter Amount">
          <div *ngIf="advancePayment.get('amount')?.touched && advancePayment.get('amount')?.invalid" class="text-danger small">
            Enter a valid amount (> 0).
          </div>
        </div>

        <div class="col-md-3">
          <label>Date</label>
          <input type="date" class="form-control" formControlName="date">
          <div *ngIf="advancePayment.get('date')?.touched && advancePayment.get('date')?.invalid" class="text-danger small">
            Payment date is required.
          </div>
        </div>
      </div>
    </mat-expansion-panel>

  </mat-accordion>

  <!-- ACTION BUTTONS -->
  <div class="d-flex gap-2 mt-3">
    <button class="btn btn-warning" type="button" (click)="onGiveEstimationLater()">Give Estimation Later</button>

    <!-- Submit disabled until form valid -->
    <button class="btn btn-success"
            type="button"
            (click)="onPrepareEstimate()">
      Prepare Estimate Now
    </button>
  </div>

</div>
